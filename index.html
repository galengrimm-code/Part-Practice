<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Hymn Trainer">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="description" content="Practice hymn voice parts with real-time pitch detection">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>Hymnal Voice Trainer</title>
  <style>
*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:linear-gradient(to bottom,#1a1a2e,#16213e);color:#e0e0e0;min-height:100vh;padding:16px;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}.container{max-width:900px;margin:0 auto}header{text-align:center;padding-bottom:16px;border-bottom:1px solid #333;margin-bottom:20px}h1{color:#d4af7d;font-size:24px;font-weight:500}header p{color:#888;margin-top:6px;font-size:14px}h2{color:#d4af7d;font-size:18px;font-weight:400;margin-bottom:12px}.hymn-list{display:grid;gap:12px}.hymn-card{background:#252540;border:1px solid #444;border-radius:12px;padding:16px;cursor:pointer;transition:all .2s}.hymn-card:active{border-color:#d4af7d}.hymn-card h3{color:#d4af7d;font-size:18px;font-weight:500;margin-bottom:4px}.hymn-card .author{color:#888;font-size:13px;margin-bottom:8px}.hymn-card .verse{color:#aaa;font-size:14px;font-style:italic}.back-btn{background:transparent;border:1px solid #555;border-radius:6px;padding:8px 14px;color:#aaa;cursor:pointer;margin-bottom:12px;font-size:14px}.section{background:#1e1e35;border-radius:12px;padding:16px;margin-bottom:16px}.section-label{font-size:11px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}.voice-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}@media(min-width:500px){.voice-grid{grid-template-columns:repeat(4,1fr)}}.voice-card{background:#252540;border:2px solid #333;border-radius:10px;padding:10px 8px;text-align:center;cursor:pointer}.voice-card.selected{border-color:var(--voice-color);background:var(--voice-bg)}.voice-card.muted{opacity:.4}.voice-card .name{text-transform:capitalize;font-size:15px;margin-bottom:2px;font-weight:500}.voice-card .range{font-size:10px;opacity:.7}.voice-controls{display:flex;gap:6px;margin-top:8px;justify-content:center}.voice-controls button{padding:6px 10px;font-size:11px;border-radius:4px;border:1px solid #555;background:#333;color:#aaa;cursor:pointer;min-width:32px}.voice-controls button.active{background:#d4af7d;color:#1a1a2e;border-color:#d4af7d}.instrument-row{display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch;scrollbar-width:none}.instrument-row::-webkit-scrollbar{display:none}.instrument-btn{padding:10px 14px;background:#252540;border:1px solid #333;border-radius:8px;color:#aaa;cursor:pointer;display:flex;align-items:center;gap:6px;white-space:nowrap;flex-shrink:0;font-size:14px}.instrument-btn.selected{background:#d4af7d22;border-color:#d4af7d;color:#d4af7d}.controls-row{display:flex;gap:12px;flex-wrap:wrap}.control-group{flex:1;min-width:140px}.control-group label{display:block;font-size:11px;color:#666;text-transform:uppercase;margin-bottom:6px}.control-row{display:flex;align-items:center;gap:8px}.control-btn{width:36px;height:36px;border-radius:8px;border:1px solid #444;background:#252540;color:#d4af7d;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}.control-value{flex:1;text-align:center;font-size:16px;color:#e0e0e0;background:#252540;padding:8px;border-radius:8px}.practice-mode{display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding-top:12px;margin-top:12px;border-top:1px solid #333}.practice-toggle{display:flex;align-items:center;gap:8px;cursor:pointer}.toggle-switch{width:48px;height:26px;background:#333;border-radius:13px;position:relative;transition:background .2s}.toggle-switch.active{background:#10b981}.toggle-switch::after{content:'';position:absolute;width:22px;height:22px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s}.toggle-switch.active::after{transform:translateX(22px)}.practice-range{display:flex;align-items:center;gap:8px;flex:1}.range-input{width:50px;padding:6px 8px;background:#252540;border:1px solid #444;border-radius:6px;color:#e0e0e0;font-size:14px;text-align:center}.progress-dots{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px;justify-content:center}.progress-dot{width:20px;height:6px;border-radius:3px;background:#333;transition:all .15s;cursor:pointer}.progress-dot.in-range{background:#555}.progress-dot.active{background:var(--voice-color,#d4af7d);box-shadow:0 0 10px var(--voice-color,#d4af7d)}.progress-dot.loop-marker{box-shadow:0 0 0 2px #10b981}@media(min-width:500px){.progress-dot{width:28px;height:8px}}.play-area{display:flex;flex-direction:column;align-items:center;gap:12px}.play-btn{width:72px;height:72px;border-radius:50%;border:none;background:linear-gradient(135deg,#d4af7d,#b8956b);color:#1a1a2e;font-size:26px;cursor:pointer;box-shadow:0 6px 25px #d4af7d66}.play-btn:active{transform:scale(.95)}.loop-indicator{display:flex;align-items:center;gap:6px;padding:6px 12px;background:#10b98122;border:1px solid #10b98144;border-radius:20px;color:#10b981;font-size:12px}.current-note{text-align:center;padding:10px 20px;background:#252540;border-radius:10px}.current-note .label{font-size:10px;color:#666;text-transform:uppercase;margin-bottom:4px}.current-note .note{font-size:32px;color:#d4af7d;font-weight:300}.pitch-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px}.mic-btn{padding:12px 18px;border-radius:8px;border:1px solid #10b981;background:#10b98122;color:#10b981;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:8px}.mic-btn.listening{background:#ef4444;border-color:#ef4444;color:#fff}.pitch-display{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}@media(max-width:360px){.pitch-display{grid-template-columns:1fr}}.pitch-box{text-align:center;padding:16px 12px;background:#252540;border-radius:12px;border:3px solid transparent}.pitch-box .label{font-size:11px;color:#666;text-transform:uppercase;margin-bottom:6px}.pitch-box .value{font-size:36px;font-weight:300}.pitch-box .freq{font-size:11px;color:#666;margin-top:4px}.pitch-box.good{border-color:#10b981;background:#10b98115}.pitch-box.good .value{color:#10b981}.pitch-box.bad{border-color:#ef4444;background:#ef444415}.pitch-box.bad .value{color:#ef4444}.pitch-box.neutral .value{color:#d4af7d}.feedback-bar{text-align:center;padding:14px;border-radius:10px;font-size:20px;font-weight:600;margin-bottom:12px}.feedback-bar.perfect{background:#10b98133;color:#10b981}.feedback-bar.good{background:#84cc1633;color:#84cc16}.feedback-bar.ok{background:#fbbf2433;color:#fbbf24}.feedback-bar.bad{background:#ef444433;color:#ef4444}.cents-display{text-align:center;font-size:13px;color:#888}.listening-indicator{display:flex;align-items:center;justify-content:center;gap:8px;color:#10b981;font-size:13px;margin-top:10px}.pulse-dot{width:10px;height:10px;border-radius:50%;background:#10b981;animation:pulse 1s infinite}@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.5}}.error-msg{background:#ef444422;border:1px solid #ef444444;border-radius:8px;padding:12px;color:#f87171;margin-bottom:12px;font-size:14px}.headphone-warning{background:#fbbf2422;border:1px solid #fbbf2444;border-radius:8px;padding:12px;color:#fbbf24;font-size:13px;margin-bottom:12px}.headphone-warning button{margin-top:10px;padding:8px 14px;background:#fbbf24;border:none;border-radius:6px;color:#1a1a2e;cursor:pointer;font-size:13px;font-weight:500}footer{text-align:center;margin-top:24px;padding-top:16px;border-top:1px solid #333;color:#555;font-size:12px}.hidden{display:none!important}@media screen and (max-width:768px){select,input,textarea,button{font-size:16px}}@supports(padding:max(0px)){body{padding-left:max(16px,env(safe-area-inset-left));padding-right:max(16px,env(safe-area-inset-right));padding-bottom:max(16px,env(safe-area-inset-bottom))}}@media(display-mode:standalone){body{padding-top:env(safe-area-inset-top,16px)}}
  </style>
</head>
<body>
  <div class="container">
    <header><h1>üéµ Hymnal Voice Trainer</h1><p>Practice your voice part with real-time pitch feedback</p></header>
    <div id="hymn-select"><h2>Select a Hymn</h2><div class="hymn-list" id="hymn-list"></div></div>
    <div id="practice" class="hidden">
      <button class="back-btn" onclick="goBack()">‚Üê Back</button>
      <h2 id="hymn-title"></h2>
      <p id="hymn-meta" style="color:#666;margin-bottom:20px"></p>
      <div class="section" style="text-align:center"><div id="verse-text"></div></div>
      <div class="section"><div class="section-label">Voice Parts (S=solo, M=mute)</div><div class="voice-grid" id="voice-grid"></div></div>
      <div class="section"><div class="section-label">Instrument</div><div class="instrument-row" id="instrument-row"></div></div>
      <div class="section">
        <div class="section-label">Tempo & Key</div>
        <div class="controls-row">
          <div class="control-group"><label>Tempo</label><div class="control-row"><button class="control-btn" onclick="adjustTempo(-5)">‚àí</button><div class="control-value" id="tempo-display">72</div><button class="control-btn" onclick="adjustTempo(5)">+</button></div></div>
          <div class="control-group"><label>Key</label><div class="control-row"><button class="control-btn" onclick="adjustKey(-1)">‚ô≠</button><div class="control-value" id="key-display">0</div><button class="control-btn" onclick="adjustKey(1)">‚ôØ</button></div></div>
        </div>
        <div class="practice-mode">
          <div class="practice-toggle" onclick="toggleLoopMode()"><div class="toggle-switch" id="loop-toggle"></div><span style="font-size:13px;color:#aaa">Loop</span></div>
          <div class="practice-range" id="loop-range-controls" style="display:none"><span style="font-size:12px;color:#666">Notes:</span><input type="number" class="range-input" id="loop-start" value="1" min="1" onchange="updateLoopRange()"><span style="color:#666">-</span><input type="number" class="range-input" id="loop-end" value="4" min="1" onchange="updateLoopRange()"></div>
        </div>
      </div>
      <div class="section">
        <div class="section-label">Playback</div>
        <div class="progress-dots" id="progress-dots"></div>
        <div class="play-area">
          <button class="play-btn" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
          <div class="loop-indicator" id="loop-indicator" style="display:none">üîÅ <span id="loop-range-text">1-4</span></div>
          <div class="current-note" id="current-note-display" style="display:none"><div class="label">Your Part</div><div class="note" id="current-note">‚Äî</div></div>
        </div>
      </div>
      <div class="section">
        <div class="pitch-header"><div class="section-label" style="margin:0">Sing Along</div><button class="mic-btn" id="mic-btn" onclick="toggleMic()">üé§ <span id="mic-btn-text">Start</span></button></div>
        <div id="mic-error" class="error-msg hidden"></div>
        <div id="headphone-warning" class="headphone-warning hidden">üéß Use headphones or mute playback<div><button onclick="togglePlaybackMute()" id="mute-playback-btn">üîá Mute Playback</button></div></div>
        <div id="pitch-ui" class="hidden">
          <div class="pitch-display"><div class="pitch-box neutral" id="target-box"><div class="label">Target</div><div class="value" id="target-note">‚Äî</div><div class="freq" id="target-freq"></div></div><div class="pitch-box neutral" id="detected-box"><div class="label">You</div><div class="value" id="detected-note">‚Äî</div><div class="freq" id="detected-freq"></div></div></div>
          <div class="feedback-bar" id="feedback-bar">Sing a note...</div>
          <div class="cents-display" id="cents-display"></div>
          <div class="listening-indicator"><div class="pulse-dot"></div>Listening...</div>
        </div>
        <p id="mic-prompt" style="text-align:center;color:#666">Tap Start to enable pitch detection</p>
      </div>
    </div>
    <footer>Built for church musicians & choir</footer>
  </div>
<script>
const HYMNS={
'amazing-grace':{id:'amazing-grace',title:'Amazing Grace',author:'John Newton, 1779',key:'G Major',tempo:72,verse:["Amazing grace! How sweet the sound","That saved a wretch like me!","I once was lost, but now am found;","Was blind, but now I see."],parts:{soprano:['D4','G4','B4','A4','G4','E4','D4','D4','G4','B4','A4','G4'],alto:['B3','D4','D4','D4','D4','C4','B3','B3','D4','D4','F#4','D4'],tenor:['G3','B3','G3','F#3','B3','G3','G3','G3','B3','G3','D4','B3'],bass:['G2','G3','G3','D3','G3','C3','G2','G2','G3','G3','D3','G2']}},
'holy-holy-holy':{id:'holy-holy-holy',title:'Holy, Holy, Holy',author:'Reginald Heber, 1826',key:'D Major',tempo:84,verse:["Holy, holy, holy!","Lord God Almighty!"],parts:{soprano:['D4','D4','F#4','F#4','A4','A4','B4','B4','A4','G4','F#4','D4'],alto:['D4','D4','D4','D4','F#4','E4','G4','F#4','F#4','E4','D4','D4'],tenor:['A3','A3','A3','A3','D4','C#4','D4','D4','D4','B3','A3','F#3'],bass:['D3','D3','D3','D3','D3','A2','G3','G3','D3','E3','D3','D3']}},
'be-thou-my-vision':{id:'be-thou-my-vision',title:'Be Thou My Vision',author:'Irish, 8th Century',key:'Eb Major',tempo:90,verse:["Be Thou my Vision,","O Lord of my heart"],parts:{soprano:['Eb4','Eb4','F4','G4','Ab4','Bb4','C5','Bb4','Ab4','G4','F4','Eb4'],alto:['Bb3','Bb3','Bb3','Eb4','Eb4','Eb4','Eb4','Eb4','Eb4','Eb4','D4','Eb4'],tenor:['G3','G3','F3','Bb3','Ab3','G3','Ab3','G3','Ab3','Bb3','Bb3','G3'],bass:['Eb3','Eb3','D3','Eb3','C3','Eb3','Ab2','Eb3','C3','Eb3','Bb2','Eb3']}}
};
const INSTRUMENTS={piano:{name:'Piano',icon:'üéπ',type:'triangle',attack:.02},guitar:{name:'Guitar',icon:'üé∏',type:'sawtooth',attack:.01},organ:{name:'Organ',icon:'‚õ™',type:'sine',attack:.1},strings:{name:'Strings',icon:'üéª',type:'sawtooth',attack:.15},flute:{name:'Flute',icon:'ü™à',type:'sine',attack:.08},bell:{name:'Bell',icon:'üîî',type:'sine',attack:.001}};
const VOICES={soprano:{color:'#E07A5F',range:'C4-C6'},alto:{color:'#9B72CF',range:'F3-F5'},tenor:{color:'#5B9BD5',range:'C3-C5'},bass:{color:'#2D9D78',range:'E2-E4'}};

let currentHymn=null,selectedVoice=null,selectedInstrument='piano',voiceStates={soprano:'on',alto:'on',tenor:'on',bass:'on'};
let isPlaying=false,noteIndex=0,currentNote=null,playInterval=null,audioCtx=null;
let tempoOffset=0,keyOffset=0,loopMode=false,loopStart=0,loopEnd=3;
let isListening=false,micStream=null,micCtx=null,analyser=null,animFrame=null,playbackMuted=false;

const noteToFreq=(n,t=0)=>{const m={'C':0,'C#':1,'Db':1,'D':2,'D#':3,'Eb':3,'E':4,'F':5,'F#':6,'Gb':6,'G':7,'G#':8,'Ab':8,'A':9,'A#':10,'Bb':10,'B':11};const p=n.match(/^([A-G]#?b?)(\d)$/);if(!p)return 440;return 440*Math.pow(2,((m[p[1]]+(parseInt(p[2])+1)*12+t)-69)/12)};
const transposeNote=(n,s)=>{if(s===0)return n;const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];const m={'C':0,'C#':1,'Db':1,'D':2,'D#':3,'Eb':3,'E':4,'F':5,'F#':6,'Gb':6,'G':7,'G#':8,'Ab':8,'A':9,'A#':10,'Bb':10,'B':11};const p=n.match(/^([A-G]#?b?)(\d)$/);if(!p)return n;const t=m[p[1]]+parseInt(p[2])*12+s;return names[((t%12)+12)%12]+Math.floor(t/12)};
const formatNote=n=>n?n.replace('#','‚ôØ').replace('b','‚ô≠'):'‚Äî';

function playNote(n,d,v=.25){if(playbackMuted)return;if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume();const i=INSTRUMENTS[selectedInstrument],o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=i.type;o.frequency.value=noteToFreq(n,keyOffset);const t=audioCtx.currentTime;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(v,t+i.attack);g.gain.exponentialRampToValueAtTime(.01,t+d);o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+d)}

function togglePlay(){isPlaying?stopPlaying():startPlaying()}
function startPlaying(){if(!currentHymn)return;stopPlaying();isPlaying=true;noteIndex=loopMode?loopStart:0;document.getElementById('play-btn').textContent='‚èπ';document.getElementById('current-note-display').style.display=selectedVoice?'block':'none';const tempo=currentHymn.tempo+tempoOffset,beat=60/tempo;function next(){const max=Math.max(...Object.values(currentHymn.parts).map(p=>p.length)),end=loopMode?Math.min(loopEnd+1,max):max;if(noteIndex>=end){if(loopMode){noteIndex=loopStart}else{stopPlaying();return}}Object.entries(VOICES).forEach(([v])=>{if(voiceStates[v]==='muted')return;const notes=currentHymn.parts[v];if(noteIndex<notes.length){const solo=Object.values(voiceStates).some(s=>s==='solo');if(!solo||voiceStates[v]==='solo')playNote(notes[noteIndex],beat*.9,v===selectedVoice?.35:.15)}});if(selectedVoice&&currentHymn.parts[selectedVoice][noteIndex]){const orig=currentHymn.parts[selectedVoice][noteIndex];currentNote=transposeNote(orig,keyOffset);document.getElementById('current-note').textContent=formatNote(currentNote);document.getElementById('target-note').textContent=formatNote(currentNote);document.getElementById('target-freq').textContent=Math.round(noteToFreq(orig,keyOffset))+' Hz'}updateProgressDots();noteIndex++}next();playInterval=setInterval(next,beat*1000)}
function stopPlaying(){if(playInterval)clearInterval(playInterval);playInterval=null;isPlaying=false;noteIndex=0;currentNote=null;document.getElementById('play-btn').textContent='‚ñ∂';document.getElementById('current-note').textContent='‚Äî';document.getElementById('target-note').textContent='‚Äî';document.getElementById('target-freq').textContent='';updateProgressDots()}

function adjustTempo(d){tempoOffset=Math.max(-40,Math.min(60,tempoOffset+d));updateTempoDisplay();if(isPlaying){stopPlaying();startPlaying()}}
function updateTempoDisplay(){if(currentHymn)document.getElementById('tempo-display').textContent=(currentHymn.tempo+tempoOffset)}
function adjustKey(d){keyOffset=Math.max(-6,Math.min(6,keyOffset+d));updateKeyDisplay()}
function updateKeyDisplay(){document.getElementById('key-display').textContent=(keyOffset>0?'+':'')+keyOffset}
function toggleLoopMode(){loopMode=!loopMode;document.getElementById('loop-toggle').classList.toggle('active',loopMode);document.getElementById('loop-range-controls').style.display=loopMode?'flex':'none';document.getElementById('loop-indicator').style.display=loopMode?'flex':'none';renderProgressDots();if(loopMode&&isPlaying){stopPlaying();startPlaying()}}
function updateLoopRange(){const max=currentHymn?Math.max(...Object.values(currentHymn.parts).map(p=>p.length)):12;loopStart=Math.max(0,parseInt(document.getElementById('loop-start').value)-1);loopEnd=Math.min(max-1,parseInt(document.getElementById('loop-end').value)-1);if(loopEnd<loopStart)loopEnd=loopStart;document.getElementById('loop-start').value=loopStart+1;document.getElementById('loop-end').value=loopEnd+1;document.getElementById('loop-range-text').textContent=(loopStart+1)+'-'+(loopEnd+1);renderProgressDots();if(isPlaying&&loopMode){stopPlaying();startPlaying()}}
function setLoopFromDot(i){if(!loopMode)return;loopStart=i;loopEnd=i;document.getElementById('loop-start').value=loopStart+1;document.getElementById('loop-end').value=loopEnd+1;document.getElementById('loop-range-text').textContent=(loopStart+1)+'-'+(loopEnd+1);renderProgressDots()}

function autoCorrelate(buf,sr){const S=buf.length,M=Math.floor(S/2);let b=-1,bc=0,rms=0;for(let i=0;i<S;i++)rms+=buf[i]*buf[i];rms=Math.sqrt(rms/S);if(rms<.01)return -1;const c=new Array(M);let l=1;for(let o=0;o<M;o++){let x=0;for(let i=0;i<M;i++)x+=Math.abs(buf[i]-buf[i+o]);x=1-x/M;c[o]=x;if(x>.9&&x>l&&x>bc){bc=x;b=o}l=x}return b>-1&&bc>.01?sr/b:-1}
function freqToNoteName(f){if(f<=0)return null;const n=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];const num=12*Math.log2(f/440)+69;const r=Math.round(num);return{name:n[((r%12)+12)%12]+(Math.floor(r/12)-1),cents:Math.round((num-r)*100),freq:f}}

function toggleMic(){isListening?stopListening():startListening()}
function togglePlaybackMute(){playbackMuted=!playbackMuted;const b=document.getElementById('mute-playback-btn');b.textContent=playbackMuted?'üîä Unmute':'üîá Mute Playback';b.style.background=playbackMuted?'#10b981':'#fbbf24'}
async function startListening(){try{document.getElementById('mic-error').classList.add('hidden');if(micStream)micStream.getTracks().forEach(t=>t.stop());if(micCtx&&micCtx.state!=='closed')await micCtx.close();if(animFrame)cancelAnimationFrame(animFrame);micStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});micCtx=new(window.AudioContext||window.webkitAudioContext)();if(micCtx.state==='suspended')await micCtx.resume();analyser=micCtx.createAnalyser();analyser.fftSize=2048;micCtx.createMediaStreamSource(micStream).connect(analyser);isListening=true;document.getElementById('mic-btn').classList.add('listening');document.getElementById('mic-btn-text').textContent='Stop';document.getElementById('pitch-ui').classList.remove('hidden');document.getElementById('mic-prompt').classList.add('hidden');document.getElementById('headphone-warning').classList.remove('hidden');const buf=new Float32Array(analyser.fftSize);function detect(){if(!analyser||!micCtx)return;analyser.getFloatTimeDomainData(buf);const f=autoCorrelate(buf,micCtx.sampleRate);if(f>50&&f<1500){updatePitchDisplay(freqToNoteName(f))}else{clearPitchDisplay()}animFrame=requestAnimationFrame(detect)}detect()}catch(e){document.getElementById('mic-error').textContent='‚ö†Ô∏è '+e.message;document.getElementById('mic-error').classList.remove('hidden');isListening=false}}
function stopListening(){if(animFrame)cancelAnimationFrame(animFrame);if(micStream)micStream.getTracks().forEach(t=>t.stop());if(micCtx&&micCtx.state!=='closed')micCtx.close();micStream=null;micCtx=null;analyser=null;animFrame=null;isListening=false;document.getElementById('mic-btn').classList.remove('listening');document.getElementById('mic-btn-text').textContent='Start';document.getElementById('pitch-ui').classList.add('hidden');document.getElementById('mic-prompt').classList.remove('hidden');document.getElementById('headphone-warning').classList.add('hidden');clearPitchDisplay()}
function updatePitchDisplay(info){const db=document.getElementById('detected-box'),tb=document.getElementById('target-box'),fb=document.getElementById('feedback-bar'),cd=document.getElementById('cents-display');document.getElementById('detected-note').textContent=formatNote(info.name);document.getElementById('detected-freq').textContent=Math.round(info.freq)+' Hz';if(currentNote){const tf=noteToFreq(currentNote);const cents=Math.round(1200*Math.log2(info.freq/tf));const ac=Math.abs(cents);cd.textContent=(cents>=0?'+':'')+cents+' cents';if(ac<=10){db.className='pitch-box good';tb.className='pitch-box good';fb.className='feedback-bar perfect';fb.textContent='‚úì Perfect!'}else if(ac<=25){db.className='pitch-box good';tb.className='pitch-box good';fb.className='feedback-bar good';fb.textContent='‚úì Good!'}else if(ac<=50){db.className='pitch-box bad';tb.className='pitch-box neutral';fb.className='feedback-bar ok';fb.textContent=cents>0?'‚Üë Sharp':'‚Üì Flat'}else{db.className='pitch-box bad';tb.className='pitch-box bad';fb.className='feedback-bar bad';fb.textContent=cents>0?'‚¨Ü Too Sharp!':'‚¨á Too Flat!'}}else{db.className='pitch-box neutral';tb.className='pitch-box neutral';fb.className='feedback-bar';fb.textContent='Press play';cd.textContent=''}}
function clearPitchDisplay(){document.getElementById('detected-note').textContent='‚Äî';document.getElementById('detected-freq').textContent='';document.getElementById('detected-box').className='pitch-box neutral';document.getElementById('target-box').className='pitch-box neutral';document.getElementById('feedback-bar').className='feedback-bar';document.getElementById('feedback-bar').textContent='Sing a note...';document.getElementById('cents-display').textContent=''}

function renderHymnList(){const l=document.getElementById('hymn-list');l.innerHTML='';Object.values(HYMNS).forEach(h=>{const c=document.createElement('div');c.className='hymn-card';c.innerHTML='<h3>'+h.title+'</h3><div class="author">'+h.author+'</div><div class="verse">"'+h.verse[0]+'"</div>';c.onclick=()=>selectHymn(h);l.appendChild(c)})}
function selectHymn(h){currentHymn=h;selectedVoice=null;voiceStates={soprano:'on',alto:'on',tenor:'on',bass:'on'};tempoOffset=0;keyOffset=0;loopMode=false;loopStart=0;loopEnd=Math.min(3,h.parts.soprano.length-1);document.getElementById('hymn-select').classList.add('hidden');document.getElementById('practice').classList.remove('hidden');document.getElementById('hymn-title').textContent=h.title;document.getElementById('hymn-meta').textContent=h.author+' ‚Ä¢ '+h.key+' ‚Ä¢ '+h.tempo+' BPM';document.getElementById('verse-text').innerHTML=h.verse.map(l=>'<p style="margin:4px 0;color:#aaa;font-style:italic;line-height:1.8">'+l+'</p>').join('');document.getElementById('loop-toggle').classList.remove('active');document.getElementById('loop-range-controls').style.display='none';document.getElementById('loop-indicator').style.display='none';document.getElementById('loop-start').value=loopStart+1;document.getElementById('loop-end').value=loopEnd+1;updateTempoDisplay();updateKeyDisplay();renderVoiceGrid();renderInstruments();renderProgressDots()}
function goBack(){stopPlaying();stopListening();currentHymn=null;selectedVoice=null;document.getElementById('hymn-select').classList.remove('hidden');document.getElementById('practice').classList.add('hidden')}
function renderVoiceGrid(){const g=document.getElementById('voice-grid');g.innerHTML='';Object.entries(VOICES).forEach(([v,info])=>{const c=document.createElement('div');c.className='voice-card'+(selectedVoice===v?' selected':'')+(voiceStates[v]==='muted'?' muted':'');c.style.setProperty('--voice-color',info.color);c.style.setProperty('--voice-bg',info.color+'33');if(selectedVoice===v)c.style.color=info.color;c.innerHTML='<div class="name">'+v+'</div><div class="range">'+info.range+'</div><div class="voice-controls"><button class="'+(voiceStates[v]==='solo'?'active':'')+'" onclick="event.stopPropagation();toggleVoiceState(\''+v+'\',\'solo\')">S</button><button class="'+(voiceStates[v]==='muted'?'active':'')+'" onclick="event.stopPropagation();toggleVoiceState(\''+v+'\',\'muted\')">M</button></div>';c.onclick=()=>{selectedVoice=v;renderVoiceGrid();renderProgressDots();document.getElementById('current-note-display').style.display=isPlaying?'block':'none'};g.appendChild(c)})}
function toggleVoiceState(v,s){if(voiceStates[v]===s){voiceStates[v]='on'}else{if(s==='solo')Object.keys(voiceStates).forEach(x=>{if(voiceStates[x]==='solo')voiceStates[x]='on'});voiceStates[v]=s}renderVoiceGrid()}
function renderInstruments(){const r=document.getElementById('instrument-row');r.innerHTML='';Object.entries(INSTRUMENTS).forEach(([id,i])=>{const b=document.createElement('button');b.className='instrument-btn'+(selectedInstrument===id?' selected':'');b.innerHTML='<span>'+i.icon+'</span> '+i.name;b.onclick=()=>{selectedInstrument=id;renderInstruments()};r.appendChild(b)})}
function renderProgressDots(){const d=document.getElementById('progress-dots');if(!currentHymn)return;const max=Math.max(...Object.values(currentHymn.parts).map(p=>p.length));d.innerHTML='';for(let i=0;i<max;i++){const dot=document.createElement('div');dot.className='progress-dot';if(loopMode&&i>=loopStart&&i<=loopEnd)dot.classList.add('in-range');if(loopMode&&(i===loopStart||i===loopEnd))dot.classList.add('loop-marker');if(selectedVoice)dot.style.setProperty('--voice-color',VOICES[selectedVoice].color);dot.onclick=()=>setLoopFromDot(i);d.appendChild(dot)}}
function updateProgressDots(){document.querySelectorAll('.progress-dot').forEach((d,i)=>{if(i===noteIndex-1&&isPlaying)d.classList.add('active');else d.classList.remove('active')})}

document.addEventListener('DOMContentLoaded',()=>{renderHymnList();if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{})});
</script>
</body>
</html>
