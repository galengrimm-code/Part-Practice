<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Part Practice">
  <meta name="theme-color" content="#0a0a0f">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.3/build/cjs/vexflow.js"></script>
  <title>Part Practice</title>
  <style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:#0a0a0f;color:#e4e4e7;min-height:100vh;padding:12px;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}
.container{max-width:900px;margin:0 auto}
header{text-align:center;padding-bottom:12px;border-bottom:1px solid #27272a;margin-bottom:16px}
h1{color:#f4f4f5;font-size:22px;font-weight:600}
header p{color:#71717a;margin-top:4px;font-size:13px}
h2{color:#f4f4f5;font-size:17px;font-weight:500;margin-bottom:10px}

.hymn-list{display:grid;gap:10px}
.hymn-card{background:#18181b;border:1px solid #27272a;border-radius:14px;padding:14px;cursor:pointer}
.hymn-card h3{color:#f4f4f5;font-size:16px;font-weight:500;margin-bottom:3px}
.hymn-card .author{color:#71717a;font-size:12px;margin-bottom:6px}
.hymn-card .verse{color:#a1a1aa;font-size:13px;font-style:italic}
.hymn-card.scan-card{border:2px dashed #3f3f46;background:transparent;text-align:center;padding:20px}
.hymn-card.scan-card .icon{font-size:28px;margin-bottom:6px}
.hymn-card.scan-card h3{color:#a1a1aa}

.back-btn{background:#18181b;border:1px solid #27272a;border-radius:8px;padding:8px 14px;color:#a1a1aa;cursor:pointer;margin-bottom:12px;font-size:13px}
.section{background:#18181b;border:1px solid #27272a;border-radius:14px;padding:12px;margin-bottom:12px}
.section-label{font-size:10px;color:#71717a;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:600}

.voice-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.voice-card{background:#27272a;border:2px solid transparent;border-radius:10px;padding:8px 4px;text-align:center;cursor:pointer}
.voice-card.selected{border-color:var(--voice-color);background:color-mix(in srgb,var(--voice-color) 15%,#18181b)}
.voice-card.muted{opacity:.35}
.voice-card .name{font-size:13px;font-weight:500;color:#f4f4f5}
.voice-card .range{font-size:9px;color:#71717a}
.voice-controls{display:flex;gap:4px;margin-top:6px;justify-content:center}
.voice-controls button{padding:4px 8px;font-size:10px;border-radius:5px;border:1px solid #3f3f46;background:#27272a;color:#a1a1aa;cursor:pointer;font-weight:600}
.voice-controls button.active{background:var(--voice-color);color:#0a0a0f;border-color:var(--voice-color)}

.instrument-row{display:flex;gap:6px;overflow-x:auto;padding-bottom:6px;scrollbar-width:none}
.instrument-row::-webkit-scrollbar{display:none}
.instrument-btn{padding:8px 12px;background:#27272a;border:1px solid #3f3f46;border-radius:8px;color:#a1a1aa;cursor:pointer;display:flex;align-items:center;gap:5px;white-space:nowrap;font-size:13px}
.instrument-btn.selected{background:#6366f1;border-color:#6366f1;color:#fff}

.controls-row{display:flex;gap:10px}
.control-group{flex:1}
.control-group label{display:block;font-size:10px;color:#71717a;text-transform:uppercase;margin-bottom:4px}
.control-row{display:flex;align-items:center;gap:6px}
.control-btn{width:36px;height:36px;border-radius:8px;border:1px solid #3f3f46;background:#27272a;color:#a1a1aa;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.control-value{flex:1;text-align:center;font-size:14px;color:#f4f4f5;background:#27272a;padding:8px;border-radius:8px}

/* Sheet Music */
.sheet-container{background:#fefefe;border-radius:10px;padding:10px;overflow-x:auto;-webkit-overflow-scrolling:touch}
#sheet-music{min-height:280px}
.note-counter{text-align:center;color:#71717a;font-size:11px;margin-top:6px}
.voice-legend{display:flex;gap:12px;justify-content:center;margin-top:8px;font-size:11px}
.voice-legend span{display:flex;align-items:center;gap:4px}
.voice-legend .dot{width:10px;height:10px;border-radius:50%}

/* Compact Play Area */
.play-controls{display:flex;align-items:center;gap:12px;justify-content:center;padding:8px 0}
.play-btn{width:56px;height:56px;border-radius:50%;border:none;background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;font-size:22px;cursor:pointer;flex-shrink:0}
.current-note-box{text-align:center;padding:8px 16px;background:#27272a;border-radius:10px}
.current-note-box .label{font-size:9px;color:#71717a;text-transform:uppercase}
.current-note-box .note{font-size:28px;color:#f4f4f5;font-weight:300}

/* Compact Pitch Monitor */
.pitch-compact{display:flex;gap:8px;align-items:stretch;margin-top:10px}
.pitch-box-sm{flex:1;text-align:center;padding:10px 8px;background:#27272a;border-radius:10px;border:2px solid transparent}
.pitch-box-sm .label{font-size:9px;color:#71717a;text-transform:uppercase}
.pitch-box-sm .value{font-size:24px;font-weight:300;color:#f4f4f5}
.pitch-box-sm .freq{font-size:9px;color:#71717a}
.pitch-box-sm.good{border-color:#22c55e;background:#22c55e11}
.pitch-box-sm.good .value{color:#22c55e}
.pitch-box-sm.bad{border-color:#ef4444;background:#ef444411}
.pitch-box-sm.bad .value{color:#ef4444}
.feedback-sm{text-align:center;padding:10px;border-radius:10px;font-size:14px;font-weight:600;background:#27272a;color:#71717a;margin-top:8px}
.feedback-sm.perfect{background:#22c55e22;color:#22c55e}
.feedback-sm.good{background:#84cc1622;color:#84cc16}
.feedback-sm.ok{background:#eab30822;color:#eab308}
.feedback-sm.bad{background:#ef444422;color:#ef4444}
.mic-btn-sm{padding:10px 16px;border-radius:10px;border:none;background:#27272a;color:#a1a1aa;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:6px}
.mic-btn-sm.listening{background:#22c55e;color:#fff}

.loop-controls{display:flex;align-items:center;gap:8px;font-size:12px;color:#71717a;margin-top:10px;justify-content:center}
.loop-controls input{width:40px;padding:4px;background:#27272a;border:1px solid #3f3f46;border-radius:6px;color:#f4f4f5;font-size:12px;text-align:center}
.toggle-sm{width:40px;height:22px;background:#3f3f46;border-radius:11px;position:relative;cursor:pointer}
.toggle-sm.active{background:#6366f1}
.toggle-sm::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s}
.toggle-sm.active::after{transform:translateX(18px)}

.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;padding:12px;z-index:1000}
.modal{background:#18181b;border:1px solid #27272a;border-radius:16px;padding:20px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto}
.modal h3{color:#f4f4f5;font-size:18px;margin-bottom:14px}
.upload-area{border:2px dashed #3f3f46;border-radius:12px;padding:20px;text-align:center;cursor:pointer}
.upload-area .icon{font-size:32px;margin-bottom:6px}
.upload-area p{color:#71717a;font-size:13px;margin:0}
.upload-area input{display:none}
.api-key-input{width:100%;padding:10px;background:#27272a;border:1px solid #3f3f46;border-radius:8px;color:#f4f4f5;font-size:14px}
.scan-btn{width:100%;padding:12px;background:linear-gradient(135deg,#6366f1,#4f46e5);border:none;border-radius:10px;color:#fff;font-size:15px;font-weight:600;cursor:pointer;margin-top:14px}
.scan-btn:disabled{opacity:.5}
.scan-status{margin-top:12px;padding:10px;background:#27272a;border-radius:8px;font-size:13px;color:#a1a1aa}
.preview-image{max-width:100%;border-radius:10px;margin-top:10px}
.error-msg{background:#ef444422;border:1px solid #ef444444;border-radius:10px;padding:10px;color:#fca5a5;font-size:13px;margin-bottom:10px}

footer{text-align:center;margin-top:20px;padding-top:12px;border-top:1px solid #27272a;color:#52525b;font-size:11px}
.hidden{display:none!important}
@supports(padding:max(0px)){body{padding-left:max(12px,env(safe-area-inset-left));padding-right:max(12px,env(safe-area-inset-right));padding-bottom:max(12px,env(safe-area-inset-bottom))}}
  </style>
</head>
<body>
  <div class="container">
    <header><h1>Part Practice</h1><p>Hymn voice trainer with real-time pitch feedback</p></header>
    
    <div id="hymn-select">
      <h2>Select a Hymn</h2>
      <div class="hymn-list" id="hymn-list"></div>
    </div>
    
    <div id="practice" class="hidden">
      <button class="back-btn" onclick="goBack()">‚Üê Back</button>
      <h2 id="hymn-title" style="margin-bottom:4px"></h2>
      <p id="hymn-meta" style="color:#71717a;font-size:12px;margin-bottom:12px"></p>
      
      <!-- Voice Selection -->
      <div class="section">
        <div class="section-label">Your Part</div>
        <div class="voice-grid" id="voice-grid"></div>
      </div>
      
      <!-- Sheet Music - All Parts on Grand Staff -->
      <div class="section">
        <div class="section-label">Sheet Music</div>
        <div class="sheet-container" id="sheet-container">
          <div id="sheet-music"></div>
        </div>
        <div class="voice-legend">
          <span><div class="dot" style="background:#f472b6"></div>Soprano</span>
          <span><div class="dot" style="background:#a78bfa"></div>Alto</span>
          <span><div class="dot" style="background:#38bdf8"></div>Tenor</span>
          <span><div class="dot" style="background:#4ade80"></div>Bass</span>
        </div>
        <div class="note-counter" id="note-counter">Note 0 / 0</div>
      </div>
      
      <!-- Play + Pitch -->
      <div class="section">
        <div class="play-controls">
          <button class="play-btn" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
          <div class="current-note-box" id="current-note-display">
            <div class="label">Your Note</div>
            <div class="note" id="current-note">‚Äî</div>
          </div>
          <button class="mic-btn-sm" id="mic-btn" onclick="toggleMic()">üé§ <span id="mic-btn-text">Mic</span></button>
        </div>
        
        <div id="pitch-ui" class="hidden">
          <div class="pitch-compact">
            <div class="pitch-box-sm" id="target-box">
              <div class="label">Target</div>
              <div class="value" id="target-note">‚Äî</div>
              <div class="freq" id="target-freq"></div>
            </div>
            <div class="pitch-box-sm" id="detected-box">
              <div class="label">You</div>
              <div class="value" id="detected-note">‚Äî</div>
              <div class="freq" id="detected-freq"></div>
            </div>
          </div>
          <div class="feedback-sm" id="feedback-bar">Sing a note...</div>
        </div>
        
        <div id="mic-error" class="error-msg hidden"></div>
        
        <div class="loop-controls">
          <span>Loop:</span>
          <div class="toggle-sm" id="loop-toggle" onclick="toggleLoopMode()"></div>
          <span id="loop-range-ui" style="display:none">
            <input type="number" id="loop-start" value="1" min="1" onchange="updateLoopRange()">
            <span>-</span>
            <input type="number" id="loop-end" value="4" min="1" onchange="updateLoopRange()">
          </span>
        </div>
      </div>
      
      <!-- Settings -->
      <details class="section">
        <summary class="section-label" style="cursor:pointer;margin-bottom:0">Settings</summary>
        <div style="padding-top:12px">
          <div class="section-label">Instrument</div>
          <div class="instrument-row" id="instrument-row"></div>
          <div style="margin-top:12px">
            <div class="controls-row">
              <div class="control-group"><label>Tempo</label><div class="control-row"><button class="control-btn" onclick="adjustTempo(-5)">‚àí</button><div class="control-value" id="tempo-display">72</div><button class="control-btn" onclick="adjustTempo(5)">+</button></div></div>
              <div class="control-group"><label>Key</label><div class="control-row"><button class="control-btn" onclick="adjustKey(-1)">‚ô≠</button><div class="control-value" id="key-display">0</div><button class="control-btn" onclick="adjustKey(1)">‚ôØ</button></div></div>
            </div>
          </div>
        </div>
      </details>
    </div>
    
    <!-- Scan Modal -->
    <div id="scan-modal" class="modal-overlay hidden">
      <div class="modal">
        <h3>üì∑ Scan Hymn</h3>
        <div style="display:flex;gap:10px;margin-bottom:10px">
          <div class="upload-area" style="flex:1" onclick="document.getElementById('image-input').click()">
            <div class="icon">üìÅ</div><p>Upload</p>
            <input type="file" id="image-input" accept="image/*,.pdf,application/pdf" onchange="handleFileSelect(event)">
          </div>
          <div class="upload-area" style="flex:1" onclick="document.getElementById('camera-input').click()">
            <div class="icon">üì∑</div><p>Camera</p>
            <input type="file" id="camera-input" accept="image/*" capture="environment" onchange="handleFileSelect(event)">
          </div>
        </div>
        <img id="preview-image" class="preview-image hidden">
        <div id="pdf-notice" class="hidden" style="padding:10px;background:#27272a;border-radius:8px;margin-top:10px;font-size:12px;color:#a1a1aa"></div>
        <button class="scan-btn" id="scan-btn" onclick="scanHymn()" disabled>Analyze Sheet Music</button>
        <div id="scan-status" class="scan-status hidden"></div>
        <button style="width:100%;padding:10px;background:#27272a;border:1px solid #3f3f46;border-radius:8px;color:#a1a1aa;margin-top:10px;cursor:pointer" onclick="closeScanModal()">Cancel</button>
      </div>
    </div>
    
    <!-- Review Modal -->
    <div id="review-modal" class="modal-overlay hidden">
      <div class="modal" style="max-width:600px">
        <h3>üìù Review Scanned Hymn</h3>
        <div style="margin-bottom:12px"><label style="font-size:11px;color:#71717a">Title</label><input type="text" id="review-title" class="api-key-input"></div>
        <div style="display:flex;gap:10px;margin-bottom:12px">
          <div style="flex:1"><label style="font-size:11px;color:#71717a">Key</label><input type="text" id="review-key" class="api-key-input"></div>
          <div style="flex:1"><label style="font-size:11px;color:#71717a">Tempo</label><input type="number" id="review-tempo" class="api-key-input"></div>
        </div>
        <div style="margin-bottom:10px"><label style="font-size:11px;color:#71717a">Lyrics</label><textarea id="review-verse" class="api-key-input" style="height:50px"></textarea></div>
        <div style="margin-bottom:8px"><label style="font-size:11px;color:#f472b6">Soprano</label><textarea id="review-soprano" class="api-key-input" style="height:40px;font-family:monospace;font-size:11px"></textarea></div>
        <div style="margin-bottom:8px"><label style="font-size:11px;color:#a78bfa">Alto</label><textarea id="review-alto" class="api-key-input" style="height:40px;font-family:monospace;font-size:11px"></textarea></div>
        <div style="margin-bottom:8px"><label style="font-size:11px;color:#38bdf8">Tenor</label><textarea id="review-tenor" class="api-key-input" style="height:40px;font-family:monospace;font-size:11px"></textarea></div>
        <div style="margin-bottom:12px"><label style="font-size:11px;color:#4ade80">Bass</label><textarea id="review-bass" class="api-key-input" style="height:40px;font-family:monospace;font-size:11px"></textarea></div>
        <div style="display:flex;gap:8px;margin-bottom:10px;text-align:center;font-size:12px">
          <div style="flex:1;padding:8px;background:#27272a;border-radius:6px"><span style="color:#f472b6" id="count-soprano">0</span> S</div>
          <div style="flex:1;padding:8px;background:#27272a;border-radius:6px"><span style="color:#a78bfa" id="count-alto">0</span> A</div>
          <div style="flex:1;padding:8px;background:#27272a;border-radius:6px"><span style="color:#38bdf8" id="count-tenor">0</span> T</div>
          <div style="flex:1;padding:8px;background:#27272a;border-radius:6px"><span style="color:#4ade80" id="count-bass">0</span> B</div>
        </div>
        <p id="count-warning" class="hidden" style="color:#fbbf24;font-size:11px;margin-bottom:10px;text-align:center">‚ö†Ô∏è Counts don't match</p>
        <button class="scan-btn" onclick="saveReviewedHymn()">‚úì Save</button>
        <button style="width:100%;padding:10px;background:#27272a;border:1px solid #3f3f46;border-radius:8px;color:#a1a1aa;margin-top:10px;cursor:pointer" onclick="closeReviewModal()">Cancel</button>
      </div>
    </div>
    
    <footer>Part Practice ‚Ä¢ Built for aspiring singers</footer>
  </div>

<script>
const {Renderer,Stave,StaveNote,Voice,Formatter,Accidental,StaveConnector}=Vex.Flow;

const HYMNS={
'amazing-grace':{id:'amazing-grace',title:'Amazing Grace',author:'John Newton, 1779',key:'G Major',tempo:72,verse:["Amazing grace! How sweet the sound","That saved a wretch like me!"],parts:{
soprano:['D4','G4','B4','B4','A4','G4','B4','A4','G4','E4','D4','D4','G4','B4','B4','A4','G4','B4','A4','B4','D5','D5','B4','D5','D5','B4','D5','B4','G4','E4','D4','D4','G4','B4','B4','A4','G4','B4','A4','G4'],
alto:['B3','D4','D4','D4','D4','D4','D4','D4','B3','C4','B3','B3','D4','D4','D4','D4','D4','D4','F#4','G4','G4','G4','G4','G4','G4','G4','G4','G4','D4','C4','B3','B3','D4','D4','D4','D4','D4','D4','D4','D4'],
tenor:['G3','B3','G3','G3','F#3','G3','G3','F#3','G3','G3','G3','G3','B3','G3','G3','F#3','G3','G3','D4','D4','B3','D4','B3','B3','B3','D4','D4','D4','B3','G3','G3','G3','B3','G3','G3','F#3','G3','G3','F#3','G3'],
bass:['G2','G3','G3','G3','D3','G3','G3','D3','G3','C3','G2','G2','G3','G3','G3','D3','G3','G3','D3','G3','G3','G3','G3','G3','G3','G3','G3','G3','G3','C3','G2','G2','G3','G3','G3','D3','G3','G3','D3','G2']}},
'holy-holy-holy':{id:'holy-holy-holy',title:'Holy, Holy, Holy',author:'Reginald Heber, 1826',key:'D Major',tempo:96,verse:["Holy, holy, holy!","Lord God Almighty!"],parts:{
soprano:['D4','D4','F#4','F#4','A4','A4','B4','A4','F#4','D4','E4','F#4','G4','G4','F#4','E4','F#4','D4','D4','F#4','F#4','A4','A4','B4','A4','F#4','D4','E4','F#4','E4','E4','D4'],
alto:['D4','D4','D4','D4','F#4','F#4','G4','F#4','D4','D4','C#4','D4','E4','E4','D4','C#4','D4','D4','D4','D4','D4','F#4','F#4','G4','F#4','D4','D4','C#4','D4','C#4','C#4','D4'],
tenor:['A3','A3','A3','A3','A3','D4','D4','D4','A3','F#3','A3','A3','A3','A3','A3','A3','A3','A3','A3','A3','A3','A3','D4','D4','D4','A3','F#3','A3','A3','A3','A3','F#3'],
bass:['D3','D3','D3','D3','D3','D3','G3','D3','D3','D3','A2','D3','A2','A2','D3','A2','D3','D3','D3','D3','D3','D3','D3','G3','D3','D3','D3','A2','D3','A2','A2','D3']}},
'be-thou-my-vision':{id:'be-thou-my-vision',title:'Be Thou My Vision',author:'Irish hymn',key:'Eb Major',tempo:100,verse:["Be Thou my Vision","O Lord of my heart"],parts:{
soprano:['Eb4','F4','G4','Ab4','Bb4','Bb4','C5','Bb4','Ab4','G4','F4','G4','Ab4','G4','F4','Eb4'],
alto:['Eb4','Eb4','Eb4','Eb4','Eb4','Eb4','Eb4','Eb4','Eb4','Eb4','D4','Eb4','Eb4','Eb4','D4','Eb4'],
tenor:['G3','Ab3','Bb3','Ab3','G3','G3','Ab3','G3','Ab3','Bb3','Bb3','Bb3','Ab3','Bb3','Bb3','G3'],
bass:['Eb3','Eb3','Eb3','C3','Eb3','Eb3','Ab2','Eb3','C3','Eb3','Bb2','Eb3','Ab2','Eb3','Bb2','Eb3']}}
};
const CUSTOM_HYMNS=JSON.parse(localStorage.getItem('customHymns')||'{}');
const INSTRUMENTS={piano:{name:'Piano',icon:'üéπ',type:'triangle',attack:.02},organ:{name:'Organ',icon:'‚õ™',type:'sine',attack:.1},strings:{name:'Strings',icon:'üéª',type:'sawtooth',attack:.15}};
const VOICES={soprano:{color:'#f472b6'},alto:{color:'#a78bfa'},tenor:{color:'#38bdf8'},bass:{color:'#4ade80'}};

let currentHymn=null,selectedVoice='soprano',selectedInstrument='piano',voiceStates={soprano:'on',alto:'on',tenor:'on',bass:'on'};
let isPlaying=false,noteIndex=0,currentNote=null,targetNote=null,playInterval=null,audioCtx=null;
let tempoOffset=0,keyOffset=0,loopMode=false,loopStart=0,loopEnd=3;
let isListening=false,micStream=null,micCtx=null,analyser=null,animFrame=null,playbackMuted=false;
let pitchHistory=[];
const PITCH_HISTORY_SIZE=5,TARGET_DELAY=400;

const noteToFreq=(n,t=0)=>{const m={'C':0,'C#':1,'Db':1,'D':2,'D#':3,'Eb':3,'E':4,'F':5,'F#':6,'Gb':6,'G':7,'G#':8,'Ab':8,'A':9,'A#':10,'Bb':10,'B':11};const p=n.match(/^([A-G]#?b?)(\d)$/);if(!p)return 440;return 440*Math.pow(2,((m[p[1]]+(parseInt(p[2])+1)*12+t)-69)/12)};
const transposeNote=(n,s)=>{if(s===0)return n;const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];const m={'C':0,'C#':1,'Db':1,'D':2,'D#':3,'Eb':3,'E':4,'F':5,'F#':6,'Gb':6,'G':7,'G#':8,'Ab':8,'A':9,'A#':10,'Bb':10,'B':11};const p=n.match(/^([A-G]#?b?)(\d)$/);if(!p)return n;const t=m[p[1]]+parseInt(p[2])*12+s;return names[((t%12)+12)%12]+Math.floor(t/12)};
const formatNote=n=>n?n.replace('#','‚ôØ').replace('b','‚ô≠'):'‚Äî';

function noteToVexKey(note,clef){
  const match=note.match(/^([A-G])([#b]?)(\d)$/);
  if(!match)return{key:'c/4',acc:null};
  let[,letter,acc,octave]=match;
  return{key:`${letter.toLowerCase()}/${octave}`,acc:acc==='#'?'#':acc==='b'?'b':null};
}

function renderSheetMusic(highlightIdx=-1){
  if(!currentHymn)return;
  const container=document.getElementById('sheet-music');
  container.innerHTML='';
  
  const soprano=currentHymn.parts.soprano||[];
  const alto=currentHymn.parts.alto||[];
  const tenor=currentHymn.parts.tenor||[];
  const bass=currentHymn.parts.bass||[];
  const maxNotes=Math.max(soprano.length,alto.length,tenor.length,bass.length);
  
  const notesPerSystem=8;
  const numSystems=Math.ceil(maxNotes/notesPerSystem);
  const staveWidth=Math.max(container.parentElement.clientWidth-40,400);
  const systemHeight=180;
  
  const renderer=new Renderer(container,Renderer.Backends.SVG);
  renderer.resize(staveWidth+40,numSystems*systemHeight+20);
  const context=renderer.getContext();
  
  for(let sys=0;sys<numSystems;sys++){
    const startNote=sys*notesPerSystem;
    const yOffset=sys*systemHeight+20;
    
    // Treble staff (Soprano + Alto)
    const trebleStave=new Stave(20,yOffset,staveWidth);
    if(sys===0)trebleStave.addClef('treble');
    trebleStave.setContext(context).draw();
    
    // Bass staff (Tenor + Bass)  
    const bassStave=new Stave(20,yOffset+80,staveWidth);
    if(sys===0)bassStave.addClef('bass');
    bassStave.setContext(context).draw();
    
    // Connect staves
    if(sys===0){
      new StaveConnector(trebleStave,bassStave).setType('brace').setContext(context).draw();
      new StaveConnector(trebleStave,bassStave).setType('singleLeft').setContext(context).draw();
    }
    new StaveConnector(trebleStave,bassStave).setType('singleRight').setContext(context).draw();
    
    // Create notes for this system
    const trebleNotes=[];
    const bassNotes=[];
    
    for(let i=0;i<notesPerSystem;i++){
      const idx=startNote+i;
      if(idx>=maxNotes)break;
      
      const sNote=soprano[idx]||'G4';
      const aNote=alto[idx]||'D4';
      const tNote=tenor[idx]||'B3';
      const bNote=bass[idx]||'G3';
      
      const isHighlight=idx===highlightIdx;
      
      // Treble: Soprano (top) + Alto (bottom)
      const sVex=noteToVexKey(sNote,'treble');
      const aVex=noteToVexKey(aNote,'treble');
      const trebleNote=new StaveNote({
        keys:[aVex.key,sVex.key],
        duration:'q',
        stem_direction:1
      });
      if(sVex.acc)trebleNote.addModifier(new Accidental(sVex.acc),1);
      if(aVex.acc)trebleNote.addModifier(new Accidental(aVex.acc),0);
      
      // Color the notes
      if(isHighlight){
        trebleNote.setStyle({fillStyle:selectedVoice==='soprano'?'#f472b6':selectedVoice==='alto'?'#a78bfa':'#6366f1',strokeStyle:selectedVoice==='soprano'?'#f472b6':selectedVoice==='alto'?'#a78bfa':'#6366f1'});
      }
      trebleNotes.push(trebleNote);
      
      // Bass: Tenor (top) + Bass (bottom)
      const tVex=noteToVexKey(tNote,'bass');
      const bVex=noteToVexKey(bNote,'bass');
      const bassNote=new StaveNote({
        keys:[bVex.key,tVex.key],
        duration:'q',
        clef:'bass',
        stem_direction:-1
      });
      if(tVex.acc)bassNote.addModifier(new Accidental(tVex.acc),1);
      if(bVex.acc)bassNote.addModifier(new Accidental(bVex.acc),0);
      
      if(isHighlight){
        bassNote.setStyle({fillStyle:selectedVoice==='tenor'?'#38bdf8':selectedVoice==='bass'?'#4ade80':'#6366f1',strokeStyle:selectedVoice==='tenor'?'#38bdf8':selectedVoice==='bass'?'#4ade80':'#6366f1'});
      }
      bassNotes.push(bassNote);
    }
    
    if(trebleNotes.length>0){
      const trebleVoice=new Voice({num_beats:trebleNotes.length,beat_value:4}).setStrict(false).addTickables(trebleNotes);
      const bassVoice=new Voice({num_beats:bassNotes.length,beat_value:4}).setStrict(false).addTickables(bassNotes);
      new Formatter().joinVoices([trebleVoice]).joinVoices([bassVoice]).format([trebleVoice,bassVoice],staveWidth-60);
      trebleVoice.draw(context,trebleStave);
      bassVoice.draw(context,bassStave);
    }
  }
  
  document.getElementById('note-counter').textContent=`Note ${highlightIdx>=0?highlightIdx+1:0} / ${maxNotes}`;
  
  // Scroll to current system
  if(highlightIdx>=0){
    const currentSystem=Math.floor(highlightIdx/notesPerSystem);
    const scrollTarget=currentSystem*systemHeight;
    const containerEl=document.getElementById('sheet-container');
    if(scrollTarget>containerEl.scrollTop+containerEl.clientHeight-200||scrollTarget<containerEl.scrollTop){
      containerEl.scrollTop=Math.max(0,scrollTarget-50);
    }
  }
}

function playNote(n,d,v=.25){if(playbackMuted)return;if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume();const i=INSTRUMENTS[selectedInstrument],o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=i.type;o.frequency.value=noteToFreq(n,keyOffset);const t=audioCtx.currentTime;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(v,t+i.attack);g.gain.exponentialRampToValueAtTime(.01,t+d);o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+d)}

function togglePlay(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume();isPlaying?stopPlaying():startPlaying()}

function startPlaying(){if(!currentHymn)return;stopPlaying();isPlaying=true;noteIndex=loopMode?loopStart:0;document.getElementById('play-btn').textContent='‚èπ';const tempo=currentHymn.tempo+tempoOffset,beat=60/tempo;
function next(){const max=Math.max(...Object.values(currentHymn.parts).map(p=>p.length)),end=loopMode?Math.min(loopEnd+1,max):max;if(noteIndex>=end){if(loopMode){noteIndex=loopStart}else{stopPlaying();return}}
Object.entries(VOICES).forEach(([v])=>{if(voiceStates[v]==='muted')return;const notes=currentHymn.parts[v];if(noteIndex<notes.length){const solo=Object.values(voiceStates).some(s=>s==='solo');if(!solo||voiceStates[v]==='solo')playNote(notes[noteIndex],beat*.9,v===selectedVoice?.35:.15)}});
if(selectedVoice&&currentHymn.parts[selectedVoice][noteIndex]){const orig=currentHymn.parts[selectedVoice][noteIndex];currentNote=transposeNote(orig,keyOffset);document.getElementById('current-note').textContent=formatNote(currentNote);renderSheetMusic(noteIndex);setTimeout(()=>{targetNote=currentNote;document.getElementById('target-note').textContent=formatNote(currentNote);document.getElementById('target-freq').textContent=Math.round(noteToFreq(orig,keyOffset))+' Hz'},TARGET_DELAY)}
noteIndex++}next();playInterval=setInterval(next,beat*1000)}

function stopPlaying(){if(playInterval)clearInterval(playInterval);playInterval=null;isPlaying=false;noteIndex=0;currentNote=null;targetNote=null;document.getElementById('play-btn').textContent='‚ñ∂';document.getElementById('current-note').textContent='‚Äî';document.getElementById('target-note').textContent='‚Äî';document.getElementById('target-freq').textContent='';renderSheetMusic(-1)}

function adjustTempo(d){tempoOffset=Math.max(-40,Math.min(60,tempoOffset+d));document.getElementById('tempo-display').textContent=currentHymn.tempo+tempoOffset;if(isPlaying){stopPlaying();startPlaying()}}
function adjustKey(d){keyOffset=Math.max(-6,Math.min(6,keyOffset+d));document.getElementById('key-display').textContent=(keyOffset>0?'+':'')+keyOffset}
function toggleLoopMode(){loopMode=!loopMode;document.getElementById('loop-toggle').classList.toggle('active',loopMode);document.getElementById('loop-range-ui').style.display=loopMode?'inline':'none';if(loopMode&&isPlaying){stopPlaying();startPlaying()}}
function updateLoopRange(){const max=currentHymn?Math.max(...Object.values(currentHymn.parts).map(p=>p.length)):12;loopStart=Math.max(0,parseInt(document.getElementById('loop-start').value)-1);loopEnd=Math.min(max-1,parseInt(document.getElementById('loop-end').value)-1);if(loopEnd<loopStart)loopEnd=loopStart;document.getElementById('loop-start').value=loopStart+1;document.getElementById('loop-end').value=loopEnd+1;if(isPlaying&&loopMode){stopPlaying();startPlaying()}}

function autoCorrelate(buf,sr){const S=buf.length,M=Math.floor(S/2);let b=-1,bc=0,rms=0;for(let i=0;i<S;i++)rms+=buf[i]*buf[i];rms=Math.sqrt(rms/S);if(rms<.01)return -1;const c=new Array(M);let l=1;for(let o=0;o<M;o++){let x=0;for(let i=0;i<M;i++)x+=Math.abs(buf[i]-buf[i+o]);x=1-x/M;c[o]=x;if(x>.9&&x>l&&x>bc){bc=x;b=o}l=x}return b>-1&&bc>.01?sr/b:-1}
function freqToNoteName(f){if(f<=0)return null;const n=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];const num=12*Math.log2(f/440)+69;const r=Math.round(num);return{name:n[((r%12)+12)%12]+(Math.floor(r/12)-1),cents:Math.round((num-r)*100),freq:f}}
function getSmoothedPitch(freq){pitchHistory.push(freq);if(pitchHistory.length>PITCH_HISTORY_SIZE)pitchHistory.shift();const vp=pitchHistory.filter(p=>p>0);if(vp.length<3)return -1;vp.sort((a,b)=>a-b);return vp[Math.floor(vp.length/2)]}

function toggleMic(){isListening?stopListening():startListening()}
async function startListening(){try{document.getElementById('mic-error').classList.add('hidden');if(micStream)micStream.getTracks().forEach(t=>t.stop());if(micCtx&&micCtx.state!=='closed')await micCtx.close();pitchHistory=[];micStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});micCtx=new(window.AudioContext||window.webkitAudioContext)();if(micCtx.state==='suspended')await micCtx.resume();analyser=micCtx.createAnalyser();analyser.fftSize=2048;analyser.smoothingTimeConstant=0.8;micCtx.createMediaStreamSource(micStream).connect(analyser);isListening=true;document.getElementById('mic-btn').classList.add('listening');document.getElementById('mic-btn-text').textContent='Stop';document.getElementById('pitch-ui').classList.remove('hidden');const buf=new Float32Array(analyser.fftSize);function detect(){if(!analyser||!micCtx)return;analyser.getFloatTimeDomainData(buf);const rawFreq=autoCorrelate(buf,micCtx.sampleRate);const f=getSmoothedPitch(rawFreq);if(f>50&&f<1500){updatePitchDisplay(freqToNoteName(f))}else{clearPitchDisplay()}animFrame=requestAnimationFrame(detect)}detect()}catch(e){document.getElementById('mic-error').textContent='‚ö†Ô∏è '+e.message;document.getElementById('mic-error').classList.remove('hidden')}}
function stopListening(){if(animFrame)cancelAnimationFrame(animFrame);if(micStream)micStream.getTracks().forEach(t=>t.stop());if(micCtx&&micCtx.state!=='closed')micCtx.close();micStream=null;micCtx=null;analyser=null;isListening=false;pitchHistory=[];document.getElementById('mic-btn').classList.remove('listening');document.getElementById('mic-btn-text').textContent='Mic';document.getElementById('pitch-ui').classList.add('hidden');clearPitchDisplay()}

function updatePitchDisplay(info){const db=document.getElementById('detected-box'),tb=document.getElementById('target-box'),fb=document.getElementById('feedback-bar');document.getElementById('detected-note').textContent=formatNote(info.name);document.getElementById('detected-freq').textContent=Math.round(info.freq)+' Hz';if(targetNote){const tf=noteToFreq(targetNote);const cents=Math.round(1200*Math.log2(info.freq/tf));const ac=Math.abs(cents);if(ac<=15){db.className='pitch-box-sm good';tb.className='pitch-box-sm good';fb.className='feedback-sm perfect';fb.textContent='‚úì Perfect!'}else if(ac<=30){db.className='pitch-box-sm good';tb.className='pitch-box-sm good';fb.className='feedback-sm good';fb.textContent='Good!'}else if(ac<=60){db.className='pitch-box-sm bad';tb.className='pitch-box-sm';fb.className='feedback-sm ok';fb.textContent=cents>0?'‚Üë Sharp':'‚Üì Flat'}else{db.className='pitch-box-sm bad';tb.className='pitch-box-sm bad';fb.className='feedback-sm bad';fb.textContent=cents>0?'‚¨Ü Too Sharp':'‚¨á Too Flat'}}else{db.className='pitch-box-sm';tb.className='pitch-box-sm';fb.className='feedback-sm';fb.textContent='Press play'}}
function clearPitchDisplay(){document.getElementById('detected-note').textContent='‚Äî';document.getElementById('detected-freq').textContent='';document.getElementById('detected-box').className='pitch-box-sm';document.getElementById('target-box').className='pitch-box-sm';document.getElementById('feedback-bar').className='feedback-sm';document.getElementById('feedback-bar').textContent='Sing...'}

// Scan
let selectedImage=null,pendingHymnData=null;
function openScanModal(){document.getElementById('scan-modal').classList.remove('hidden')}
function closeScanModal(){document.getElementById('scan-modal').classList.add('hidden');selectedImage=null;document.getElementById('preview-image').classList.add('hidden');document.getElementById('pdf-notice').classList.add('hidden');document.getElementById('scan-btn').disabled=true;document.getElementById('scan-status').classList.add('hidden')}
async function handleFileSelect(e){const file=e.target.files[0];if(!file)return;if(file.type==='application/pdf'){document.getElementById('pdf-notice').classList.remove('hidden');document.getElementById('pdf-notice').textContent='üìÑ '+file.name;try{const ab=await file.arrayBuffer();const pdf=await pdfjsLib.getDocument({data:ab}).promise;const page=await pdf.getPage(1);const vp=page.getViewport({scale:2});const canvas=document.createElement('canvas');canvas.width=vp.width;canvas.height=vp.height;await page.render({canvasContext:canvas.getContext('2d'),viewport:vp}).promise;selectedImage=canvas.toDataURL('image/png');document.getElementById('preview-image').src=selectedImage;document.getElementById('preview-image').classList.remove('hidden');document.getElementById('scan-btn').disabled=false}catch(err){document.getElementById('pdf-notice').textContent='Error: '+err.message}}else{const reader=new FileReader();reader.onload=ev=>{selectedImage=ev.target.result;document.getElementById('preview-image').src=selectedImage;document.getElementById('preview-image').classList.remove('hidden');document.getElementById('scan-btn').disabled=false};reader.readAsDataURL(file)}}
async function scanHymn(){if(!selectedImage)return;const status=document.getElementById('scan-status');status.classList.remove('hidden');status.textContent='Analyzing...';document.getElementById('scan-btn').disabled=true;try{const base64=selectedImage.split(',')[1];const mediaType=selectedImage.split(';')[0].split(':')[1];const response=await fetch('/api/scan',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:base64,mediaType})});const data=await response.json();if(!response.ok)throw new Error(data.error||'Failed');const text=data.content[0].text;let hymnData;try{hymnData=JSON.parse(text)}catch(e){const m=text.match(/\{[\s\S]*\}/);if(m)hymnData=JSON.parse(m[0]);else throw new Error('Parse error')}pendingHymnData=hymnData;closeScanModal();showReviewModal(hymnData)}catch(e){status.textContent='Error: '+e.message;document.getElementById('scan-btn').disabled=false}}
function showReviewModal(d){document.getElementById('review-modal').classList.remove('hidden');document.getElementById('review-title').value=d.title||'';document.getElementById('review-key').value=d.key||'';document.getElementById('review-tempo').value=d.tempo||72;document.getElementById('review-verse').value=(d.verse||[]).join('\n');document.getElementById('review-soprano').value=(d.parts?.soprano||[]).join(' ');document.getElementById('review-alto').value=(d.parts?.alto||[]).join(' ');document.getElementById('review-tenor').value=(d.parts?.tenor||[]).join(' ');document.getElementById('review-bass').value=(d.parts?.bass||[]).join(' ');updateNoteCounts()}
function closeReviewModal(){document.getElementById('review-modal').classList.add('hidden')}
function updateNoteCounts(){const counts=['soprano','alto','tenor','bass'].map(p=>document.getElementById('review-'+p).value.trim().split(/\s+/).filter(n=>n).length);['soprano','alto','tenor','bass'].forEach((p,i)=>document.getElementById('count-'+p).textContent=counts[i]);document.getElementById('count-warning').classList.toggle('hidden',counts.every(c=>c===counts[0]))}
['soprano','alto','tenor','bass'].forEach(p=>document.getElementById('review-'+p)?.addEventListener('input',updateNoteCounts));
function saveReviewedHymn(){const title=document.getElementById('review-title').value.trim();if(!title)return alert('Enter title');const h={id:'custom-'+Date.now(),title,author:'Scanned',key:document.getElementById('review-key').value||'',tempo:parseInt(document.getElementById('review-tempo').value)||72,verse:document.getElementById('review-verse').value.split('\n').filter(l=>l),parts:{soprano:document.getElementById('review-soprano').value.trim().split(/\s+/).filter(n=>n),alto:document.getElementById('review-alto').value.trim().split(/\s+/).filter(n=>n),tenor:document.getElementById('review-tenor').value.trim().split(/\s+/).filter(n=>n),bass:document.getElementById('review-bass').value.trim().split(/\s+/).filter(n=>n)}};CUSTOM_HYMNS[h.id]=h;localStorage.setItem('customHymns',JSON.stringify(CUSTOM_HYMNS));closeReviewModal();renderHymnList()}

function renderHymnList(){const l=document.getElementById('hymn-list');l.innerHTML='';const sc=document.createElement('div');sc.className='hymn-card scan-card';sc.innerHTML='<div class="icon">üì∑</div><h3>Scan Hymn</h3>';sc.onclick=openScanModal;l.appendChild(sc);[...Object.values(HYMNS),...Object.values(CUSTOM_HYMNS)].forEach(h=>{const c=document.createElement('div');c.className='hymn-card';c.innerHTML=`<h3>${h.title}</h3><div class="author">${h.author}</div><div class="verse">"${h.verse[0]||''}"</div>`;c.onclick=()=>selectHymn(h);l.appendChild(c)})}

function selectHymn(h){currentHymn=h;selectedVoice='soprano';voiceStates={soprano:'on',alto:'on',tenor:'on',bass:'on'};tempoOffset=0;keyOffset=0;loopMode=false;loopStart=0;loopEnd=Math.min(7,h.parts.soprano.length-1);document.getElementById('hymn-select').classList.add('hidden');document.getElementById('practice').classList.remove('hidden');document.getElementById('hymn-title').textContent=h.title;document.getElementById('hymn-meta').textContent=`${h.author} ‚Ä¢ ${h.key} ‚Ä¢ ${h.tempo} BPM`;document.getElementById('tempo-display').textContent=h.tempo;document.getElementById('key-display').textContent='0';document.getElementById('loop-toggle').classList.remove('active');document.getElementById('loop-range-ui').style.display='none';document.getElementById('loop-start').value=1;document.getElementById('loop-end').value=loopEnd+1;renderVoiceGrid();renderInstruments();setTimeout(()=>renderSheetMusic(-1),100)}

function goBack(){stopPlaying();stopListening();document.getElementById('hymn-select').classList.remove('hidden');document.getElementById('practice').classList.add('hidden')}

function renderVoiceGrid(){const g=document.getElementById('voice-grid');g.innerHTML='';const names={soprano:'Soprano',alto:'Alto',tenor:'Tenor',bass:'Bass'};Object.entries(names).forEach(([v,name])=>{const c=document.createElement('div');c.className='voice-card'+(selectedVoice===v?' selected':'')+(voiceStates[v]==='muted'?' muted':'');c.style.setProperty('--voice-color',VOICES[v].color);c.innerHTML=`<div class="name">${name}</div><div class="voice-controls"><button class="${voiceStates[v]==='solo'?'active':''}" onclick="event.stopPropagation();toggleVoiceState('${v}','solo')">S</button><button class="${voiceStates[v]==='muted'?'active':''}" onclick="event.stopPropagation();toggleVoiceState('${v}','muted')">M</button></div>`;c.onclick=()=>{selectedVoice=v;renderVoiceGrid();renderSheetMusic(isPlaying?noteIndex-1:-1)};g.appendChild(c)})}
function toggleVoiceState(v,s){if(voiceStates[v]===s)voiceStates[v]='on';else{if(s==='solo')Object.keys(voiceStates).forEach(x=>{if(voiceStates[x]==='solo')voiceStates[x]='on'});voiceStates[v]=s}renderVoiceGrid()}
function renderInstruments(){const r=document.getElementById('instrument-row');r.innerHTML='';Object.entries(INSTRUMENTS).forEach(([id,i])=>{const b=document.createElement('button');b.className='instrument-btn'+(selectedInstrument===id?' selected':'');b.innerHTML=`${i.icon} ${i.name}`;b.onclick=()=>{selectedInstrument=id;renderInstruments()};r.appendChild(b)})}

document.addEventListener('DOMContentLoaded',()=>{renderHymnList();if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{})});
</script>
</body>
</html>
